---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import IconHash from "@/assets/icons/IconHash.svg";
import { SITE } from "@/config";
import { SOCIALS } from "@/constants";
import { getPath } from "@/utils/getPath";
import { slugifyStr } from "@/utils/slugify";

const posts = await getCollection("blog");

const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);

// Editorial helpers
const now = new Date();
const monthNames = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December",
];
const issueMonth = monthNames[now.getMonth()];
const issueYear = now.getFullYear();
const issueNumber = (now.getFullYear() - 2024) * 12 + now.getMonth() + 1;

function formatEditorialDate(date: string | Date) {
  const d = new Date(date);
  return d.toLocaleDateString("en-US", {
    month: "long", day: "numeric", year: "numeric",
  });
}

// Lead post gets hero treatment; remaining fill the grid
const heroPost = featuredPosts.length > 0 ? featuredPosts[0] : recentPosts[0];
const secondaryFeatured = featuredPosts.length > 1 ? featuredPosts.slice(1) : [];
const gridPosts = [
  ...secondaryFeatured,
  ...(featuredPosts.length > 0 ? recentPosts : recentPosts.slice(1)),
].slice(0, SITE.postPerIndex);
---

<Layout>
  <Header />
  <section id="hero" class="animate-reveal overflow-hidden bg-hero-bg transition-[background] duration-300">
    <div class="app-layout">
      <div class="flex flex-col items-center gap-6 py-8 sm:py-10 md:flex-row md:items-end md:justify-between md:gap-8 md:py-0">
        <div class="text-center md:flex-1 md:py-16 md:text-left lg:py-20 xl:py-24">
          <img
            src="/avatar.png"
            alt="Matt Wicks"
            width="160"
            height="160"
            class="mx-auto block size-35 rounded-full object-cover object-top sm:size-40 md:hidden"
          />
          <p class="editorial-issue-label mt-4 md:mt-0">
            <span class="editorial-issue-rule"></span>
            Issue No.&thinsp;{issueNumber} &mdash; {issueMonth} {issueYear}
          </p>
          <h1 class="mt-3 font-prose text-4xl font-bold italic tracking-tight text-hero-text sm:text-5xl lg:text-6xl xl:text-7xl">
            Matt Wicks
          </h1>
          <p class="editorial-tagline mx-auto mt-4 max-w-lg md:mx-0">
            <span class="editorial-quote-mark">&ldquo;</span>Exploring CI/CD, DevOps, cloud-native architecture, and clean code &mdash; sharing practical tips and hard-won lessons from the trenches.<span class="editorial-quote-mark">&rdquo;</span>
          </p>
          <p class="mt-3 text-sm font-semibold uppercase tracking-widest text-hero-accent">
            Solution Architect at{" "}
            <a
              href="https://ssw.com.au/people/matt-wicks/"
              target="_blank"
              rel="noopener noreferrer"
              class="underline decoration-dashed underline-offset-4 hover:decoration-solid"
            >
              SSW
            </a>
          </p>
          {
            SOCIALS.length > 0 && (
              <div class="mt-5 [&_svg]:stroke-hero-social [&_svg]:hover:stroke-hero-accent">
                <Socials />
              </div>
            )
          }
        </div>
        <div class="relative hidden md:block md:shrink-0 after:content-[''] after:absolute after:bottom-0 after:inset-x-0 after:h-[40%] after:pointer-events-none after:bg-gradient-to-t after:from-hero-bg after:to-transparent after:transition-[background] after:duration-300">
          <img
            src="/avatar.png"
            alt="Matt Wicks"
            width="500"
            height="500"
            class="hero-avatar"
          />
        </div>
      </div>
    </div>
  </section>

  <main id="main-content" data-layout="index" class="app-layout">
    {heroPost && (
      <section id="featured" class="animate-reveal-delay-1 editorial-lead-section">
        <div class="editorial-section-header">
          <span class="editorial-section-label">Lead Story</span>
          <span class="editorial-section-rule"></span>
        </div>
        <article class="editorial-lead-card group">
          <a
            href={getPath(heroPost.id, heroPost.filePath)}
            class="editorial-lead-link"
          >
            <h2
              class="editorial-lead-title"
              style={{ viewTransitionName: slugifyStr(heroPost.data.title.replaceAll(".", "-")) }}
            >
              {heroPost.data.title}
            </h2>
          </a>
          <p class="editorial-lead-description">{heroPost.data.description}</p>
          <div class="editorial-lead-meta">
            <time
              datetime={new Date(heroPost.data.pubDatetime).toISOString()}
              class="editorial-meta-date"
            >
              {formatEditorialDate(heroPost.data.pubDatetime)}
            </time>
            {heroPost.data.tags.length > 0 && (
              <ul class="editorial-tag-list">
                {heroPost.data.tags.map((tag: string) => (
                  <li>
                    <a
                      href={`/tags/${slugifyStr(tag)}/`}
                      class="editorial-tag"
                    >
                      <IconHash class="size-3 opacity-70" />{tag}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </article>
      </section>
    )}

    <hr class="editorial-divider animate-reveal-delay-1" />

    {gridPosts.length > 0 && (
      <section id="recent-posts" class="animate-reveal-delay-2 editorial-grid-section">
        <div class="editorial-section-header">
          <span class="editorial-section-label">Recent Dispatches</span>
          <span class="editorial-section-rule"></span>
        </div>
        <div class="editorial-grid">
          {gridPosts.map((post) => (
            <article class="editorial-grid-card group">
              <a
                href={getPath(post.id, post.filePath)}
                class="editorial-card-link"
              >
                <h3
                  class="editorial-card-title"
                  style={{ viewTransitionName: slugifyStr(post.data.title.replaceAll(".", "-")) }}
                >
                  {post.data.title}
                </h3>
              </a>
              <p class="editorial-card-description">{post.data.description}</p>
              <div class="editorial-card-meta">
                <time
                  datetime={new Date(post.data.pubDatetime).toISOString()}
                  class="editorial-meta-date"
                >
                  {formatEditorialDate(post.data.pubDatetime)}
                </time>
              </div>
              {post.data.tags.length > 0 && (
                <ul class="editorial-tag-list editorial-card-tags">
                  {post.data.tags.slice(0, 3).map((tag: string) => (
                    <li>
                      <a
                        href={`/tags/${slugifyStr(tag)}/`}
                        class="editorial-tag"
                      >
                        <IconHash class="size-3 opacity-70" />{tag}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </article>
          ))}
        </div>
      </section>
    )}

    <div class="animate-reveal-delay-3 editorial-cta-wrap">
      <hr class="editorial-divider" />
      <a href="/blog/" class="editorial-cta group">
        <span class="editorial-cta-text">Continue to the Archive</span>
        <IconArrowRight class="inline-block size-4 transition-transform duration-300 group-hover:translate-x-1 rtl:-rotate-180" />
      </a>
    </div>
  </main>
  <Footer />
</Layout>


<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
