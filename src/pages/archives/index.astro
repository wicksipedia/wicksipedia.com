---
import { getCollection } from "astro:content";
import Card from "@/components/Card.astro";
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import { SITE } from "@/config";
import Layout from "@/layouts/Layout.astro";
import Main from "@/layouts/Main.astro";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
	return Astro.redirect("/404");
}

const posts = await getCollection("blog", ({ data }) => !data.draft);

const months = [
	"January",
	"February",
	"March",
	"April",
	"May",
	"June",
	"July",
	"August",
	"September",
	"October",
	"November",
	"December",
];
---

<Layout title={`Archives | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Archives" pageDesc="All the articles I've archived." sectionLabel="The Archive">
    {
      Object.entries(
        getPostsByGroupCondition(posts, post =>
          post.data.pubDatetime.getFullYear()
        )
      )
        .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
        .map(([year, yearGroup]) => (
          <div class="mt-8 first:mt-4">
            <div class="flex items-baseline gap-2">
              <span class="text-2xl font-extrabold tracking-tight text-foreground">
                {year}
              </span>
              <span class="rounded-full bg-accent/10 px-2 py-0.5 text-xs font-semibold text-accent">
                {yearGroup.length}
              </span>
            </div>
            {Object.entries(
              getPostsByGroupCondition(
                yearGroup,
                post => post.data.pubDatetime.getMonth() + 1
              )
            )
              .sort(([monthA], [monthB]) => Number(monthB) - Number(monthA))
              .map(([month, monthGroup]) => (
                <div class="flex flex-col border-l-2 border-border/50 ml-2 pl-4 sm:flex-row sm:border-l-0 sm:ml-0 sm:pl-0">
                  <div class="mt-6 min-w-36 text-lg sm:my-6">
                    <span class="font-bold text-foreground/80">
                      {months[Number(month) - 1]}
                    </span>
                    <span class="ml-1.5 text-xs font-medium text-foreground/40">
                      {monthGroup.length}
                    </span>
                  </div>
                  <ul class="flex-1">
                    {monthGroup
                      .sort(
                        (a, b) =>
                          Math.floor(
                            new Date(b.data.pubDatetime).getTime() / 1000
                          ) -
                          Math.floor(
                            new Date(a.data.pubDatetime).getTime() / 1000
                          )
                      )
                      .map(data => (
                        <Card {...data} />
                      ))}
                  </ul>
                </div>
              ))}
          </div>
        ))
    }
  </Main>
  <Footer />
</Layout>
